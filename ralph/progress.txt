# Laravel OpenAPI CLI - Progress Log

## Codebase Patterns
(Patterns will be added as they are discovered during implementation)

---

## 2026-01-28 - US-043
- Added `symfony/yaml` ^7.0 dependency to composer.json
- Verified all composer scripts work correctly (validate, analyse, format, test)
- **Learnings for future iterations:**
  - The package uses Spatie's laravel-package-tools structure
  - All quality checks must pass before committing: `composer analyse`, `composer format`, and `composer test`
  - Dependencies in composer.json must be in the `require` section, not `require-dev`
  - Composer validation ensures the configuration file is correct
---

## 2026-01-28 - US-001
- Verified and cleaned up package foundation structure
- Confirmed directory structure exists (src/, tests/, config/)
- Verified OpenApiCliServiceProvider extends PackageServiceProvider correctly
- Verified Facade pattern exists in src/Facades/OpenApiCli.php
- Removed unnecessary skeleton code from ServiceProvider (views, migrations, command)
- All composer scripts work correctly (analyse, format, test)
- Package namespace is properly set to Spatie\OpenApiCli
- Files changed: src/OpenApiCliServiceProvider.php
- **Learnings for future iterations:**
  - The ServiceProvider should only include features the package actually uses (no views or migrations for this CLI package)
  - The package skeleton includes many features that should be removed if not needed
  - The Facade pattern is already properly set up using Laravel's standard Facade class
  - All PHP files must use the `Spatie\OpenApiCli` namespace as defined in composer.json autoload
---
## 2026-01-28 - US-002
- Created OpenApiParser class in src/OpenApiParser.php
- Implemented YAML and JSON parsing support using Symfony YAML component
- Added methods to extract paths, HTTP methods, operation summaries and descriptions
- Added method to extract path parameters with their types (handles array types)
- Added method to extract request body schemas
- Added method to extract servers[0].url with graceful handling for missing/empty servers arrays
- Created comprehensive unit tests (16 test cases) in tests/Unit/OpenApiParserTest.php
- All quality checks pass (analyse, format, test)
- Files changed: src/OpenApiParser.php, tests/Unit/OpenApiParserTest.php
- **Learnings for future iterations:**
  - Use sys_get_temp_dir().'/filename_'.uniqid().'.ext' for temp files in tests, not tempnam() (needs extension for file type detection)
  - The OpenAPI spec uses lowercase HTTP method names as keys (get, post, put, patch, delete)
  - Parameters with 'in: path' are path parameters; filter these from the parameters array
  - The schema type can be an array in OpenAPI 3.1 (e.g., type: [integer, string]); use first element as primary type
  - Request body schema is nested: requestBody.content.application/json.schema
  - Always check for null/missing values when traversing nested OpenAPI spec structures
  - Tests should use the flare-api.yaml fixture for realistic OpenAPI spec parsing
---
## 2026-01-28 - US-003
- Added comprehensive JSON parsing tests to verify JSON support (already implemented in US-002)
- Verified auto-detection of format based on file extension (.yaml, .yml, .json)
- Confirmed same extraction capabilities work for JSON as YAML
- Confirmed clear error messages for invalid JSON syntax
- All quality checks pass (analyse, format, test)
- Files changed: tests/Unit/OpenApiParserTest.php
- **Learnings for future iterations:**
  - The OpenApiParser implementation in US-002 already included full JSON support via the parseFile/parseJson methods
  - Using match() expression for file extension detection makes it easy to support multiple formats
  - JSON_THROW_ON_ERROR flag ensures clear error messages for invalid JSON
  - Tests should verify both YAML and JSON work identically for all extraction methods
---
## 2026-01-28 - US-004
- Created RefResolver class in src/RefResolver.php
- Implemented resolution of simple $ref pointers (e.g., '#/components/schemas/User')
- Implemented recursive resolution for nested refs (refs within resolved objects)
- Added support for refs in arrays and complex structures like allOf
- Implemented JSON pointer lookup with proper decoding (~0 for ~, ~1 for /)
- Added error handling for invalid ref pointers and external references
- Created comprehensive test suite with 13 test cases in tests/Unit/RefResolverTest.php
- All quality checks pass (analyse, format, test)
- Files changed: src/RefResolver.php, tests/Unit/RefResolverTest.php
- **Learnings for future iterations:**
  - JSON pointer uses ~0 to represent ~ and ~1 to represent / (must decode during resolution)
  - References can be nested deeply and must be resolved recursively
  - The resolve() method should handle both the $ref lookup AND recursive resolution of the result
  - Always check if a value is an array before trying to access keys to avoid type errors
  - Test edge cases like allOf, deeply nested refs, and multiple refs in the same structure
  - External references (not starting with '#/') should be explicitly rejected with clear error messages
---
## 2026-01-28 - US-005
- Created PathMatcher class in src/PathMatcher.php
- Implemented convertToRegex() method to convert OpenAPI path templates to regex patterns
- Converts {param} syntax to named capture groups (?P<param>[^/]+)
- Uses ~ as regex delimiter to avoid escaping forward slashes
- Handles multiple parameters, underscores in parameter names, and special regex characters
- Created comprehensive test suite with 14 test cases in tests/Unit/PathMatcherTest.php
- All quality checks pass (analyse, format, test)
- Files changed: src/PathMatcher.php, tests/Unit/PathMatcherTest.php
- **Learnings for future iterations:**
  - Use a delimiter other than `/` for regex patterns (like `~`) to avoid having to escape forward slashes in paths
  - preg_quote($string, $delimiter) will escape characters based on the delimiter chosen
  - Named capture groups in PHP regex use the format (?P<name>pattern)
  - The pattern [^/]+ matches any character except forward slash, perfect for path parameters
  - Tests should verify both the regex pattern format and actual matching behavior
  - Trailing slash handling can be done with /?$ at the end of the pattern
---
## 2026-01-28 - US-006
- Implemented matchPath() method in PathMatcher class
- Added user input matching against OpenAPI spec paths with parameter extraction
- Implemented slash normalization (leading/trailing slash equivalence)
- Added HTTP method extraction from matched paths
- Implemented match prioritization (exact matches before parameterized matches)
- Created 16 comprehensive test cases for matchPath functionality
- All quality checks pass (analyse, format, test)
- Files changed: src/PathMatcher.php, tests/Unit/PathMatcherTest.php
- **Learnings for future iterations:**
  - Use array_filter with ARRAY_FILTER_USE_KEY to extract only named captures from preg_match results
  - When normalizing paths, trim slashes then add back the leading slash: '/'.trim($input, '/')
  - usort() can be used to prioritize results based on custom criteria (e.g., exact vs parameterized)
  - The matchPath method returns structured arrays with path, parameters, methods, and isExact flag
  - Test for edge cases: leading/trailing slashes, special characters in parameters, multiple matches
  - When multiple paths match the same input, return all matches (let the caller decide how to handle)
  - HTTP methods in OpenAPI specs are lowercase keys (get, post, etc.) - use array_map('strtoupper') to normalize
---
## 2026-01-28 - US-007
- Implemented checkAmbiguity() method in PathMatcher class
- Added ambiguity detection logic (when 2+ matches exist)
- Created formatted error message showing all matching paths with their HTTP methods
- Added --method flag suggestion in error message with example usage
- Error message includes the command name for contextual examples
- Created 8 comprehensive test cases for ambiguity checking
- All quality checks pass (analyse, format, test)
- Files changed: src/PathMatcher.php, tests/Unit/PathMatcherTest.php
- **Learnings for future iterations:**
  - The checkAmbiguity method returns a structured array with 'isAmbiguous' boolean and optional 'message' string
  - Error messages should be clear and actionable, suggesting how to resolve the issue (--method flag)
  - Include the actual command name in examples to make error messages contextual
  - Test all edge cases: 0 matches, 1 match (not ambiguous), 2 matches, 3+ matches
  - implode(', ', $array) is perfect for formatting comma-separated lists (like HTTP methods)
  - The caller (command execution) will be responsible for displaying the error and exiting with error code
---
## 2026-01-28 - US-008
- Created CommandConfiguration class for fluent chaining with getters for all configuration options
- Implemented OpenApiCli::register() static method that creates and stores CommandConfiguration instances
- Created OpenApiCommand class that extends Laravel's Command and accepts CommandConfiguration
- Updated OpenApiCliServiceProvider::packageRegistered() to register all commands dynamically
- Added comprehensive feature tests with 7 test cases covering registration, chaining, and artisan list
- All quality checks pass (analyse, format, test - 76 tests passing)
- Files changed: src/OpenApiCli.php, src/CommandConfiguration.php, src/Commands/OpenApiCommand.php, src/OpenApiCliServiceProvider.php, tests/Feature/CommandRegistrationTest.php
- **Learnings for future iterations:**
  - Commands must be registered in the ServiceProvider's packageRegistered() method using $this->commands()
  - Use singleton binding for command instances to ensure configuration is preserved
  - CommandConfiguration acts as a DTO to pass configuration from registration to command execution
  - The signature property must be set before calling parent::__construct() in Command classes
  - Use OpenApiCli::clearRegistrations() in tests to prevent state leaking between tests
  - Re-bootstrap the service provider with $this->app->register() to test command registration in artisan list
  - Fluent methods should return $this to enable method chaining
  - Store registrations as static array to persist across service provider lifecycle
---

## 2026-01-28 - US-013
- Implemented resolveBaseUrl() method in OpenApiCommand
- Method checks configured baseUrl first, then falls back to spec's servers[0].url
- Throws RuntimeException if no base URL is available (neither configured nor in spec)
- Created comprehensive feature tests (5 test cases) covering all scenarios
- All quality checks pass (analyse, format, test - 81 tests passing)
- Files changed: src/Commands/OpenApiCommand.php, tests/Feature/BaseUrlConfigurationTest.php
- **Learnings for future iterations:**
  - The baseUrl() and getBaseUrl() methods were already implemented in CommandConfiguration (from US-008)
  - Use reflection to test protected methods in feature tests: $reflection->getMethod('methodName')->setAccessible(true)
  - When creating temp files for tests, include uniqid() in filename to prevent conflicts
  - Always clean up temp files in tests using try/finally blocks
  - The resolveBaseUrl() method prioritizes: 1) configured baseUrl, 2) spec servers[0].url, 3) throw exception
  - RuntimeException is appropriate for configuration errors that should halt execution
---
## 2026-01-28 - US-009
- Implemented applyAuthentication() protected method in OpenApiCommand
- Method accepts PendingRequest and applies configured authentication headers
- Bearer token authentication uses Laravel's withToken() method
- Also implemented API key (withHeader), basic auth (withBasicAuth), and callable auth
- Authentication methods are prioritized: bearer > apiKey > basic > callable
- Created comprehensive test suite with 7 test cases in tests/Unit/AuthenticationTest.php
- All quality checks pass (analyse, format, test - 88 tests passing)
- Files changed: src/Commands/OpenApiCommand.php, tests/Unit/AuthenticationTest.php
- **Learnings for future iterations:**
  - Use Http::withHeaders([]) to create a PendingRequest instance for testing (Http::fake() returns Factory)
  - Laravel's HTTP client provides withToken(), withHeader(), and withBasicAuth() methods
  - Bearer token format is automatically handled by withToken() (adds "Bearer " prefix)
  - Basic auth encoding is automatically handled by withBasicAuth() (base64 encodes credentials)
  - Callable auth should be invoked fresh on each request to support dynamic token retrieval
  - When testing protected methods, use ReflectionClass to access them in tests
  - Http::assertSent() can verify headers were correctly applied in test assertions
  - The applyAuthentication method implements a priority system for multiple auth configs
---
